<!DOCTYPE html>

<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <title>우리집 DayCareCenter</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase.js"></script>
    <script type="module" src="https://sclass0614.github.io/authCheck/authCheck.js"></script>

</head>

<body>
    <div id="loadingOverlay">
        <div class="loader"></div>
        <div class="loading-text">데이터를 처리중입니다...</div>
    </div>

    <header id="main-header">
        <h1 id="app-title">
            <i class="fas fa-home header-icon"></i>
            우리집 DayCareCenter
        </h1>
    </header>

    <div id="staffSelectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="staff-modal-title">직원명 선택</h3>
                <span id="close-staff-btn" class="close-staff-modal">&times;</span>
            </div>
            <input type="text" id="staffSearchBox" class="search-box" placeholder="직원명 검색 (이름 또는 직원번호)..." />
            <div id="staff-table-container" class="table-container modal-table-container">
                <table class="list-table" id="staff-list-table">
                    <thead>
                        <tr id="staff-list-header">
                            <th style="width: 60px; text-align: center;">선택</th>
                            <th>직원번호</th>
                            <th>이름</th>
                        </tr>
                    </thead>
                    <tbody id="staff-list-body">
                    </tbody>
                </table>
            </div>
            <div class="staff-button-container">
                <button id="resetManagerBtn" class="btn-icon">초기화</button>
                <button id="selectStaffCompleteBtn" class="btn-icon" style="background-color: #4caf50; color: white;">선택완료</button>
            </div>
        </div>
    </div>

    <main id="app-main">
        <section class="page active" id="page1">
            <div id="plan-header" class="header-container">
                <h2 id="plan-title">Daily Plan</h2>
                <div id="date-search" class="date-search-container">
                    <div class="input-group" style="display: flex; align-items: center; gap: 5px;">
                        <input type="date" id="datePicker" class="form-control" onchange="makeTable_plan()" />
                        <button type="button" id="btn-plan-search" class="btn btn-primary">
                            <i class="fas fa-sync-alt"></i> Update
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="plan-table-container" class="panel thick-border">
                <div class="table-container">
                    <table class="list-table" id="daily-plan-table">
                        <thead>
                            <tr id="plan-table-header">
                                <th>날짜</th>
                                <th>시작시간</th>
                                <th>종료시간</th>
                                <th>직원번호</th>
                                <th>직원명</th>
                                <th>활동명</th>
                                <th>코드</th>
                                <th>활동장소</th>
                                <th>준비물품</th>
                                <th>내용및특이사항</th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="copy-date-section" class="header-container" style="margin-top: 20px;">
                <h2>Plan Copy</h2>
                <div class="date-search-container">
                    <div class="input-group" style="display: flex; align-items: center; gap: 5px;">
                        <input type="date" id="datePickerCopy" class="form-control" />
                        <button type="button" id="btn-copy-save" class="btn btn-primary">
                            <i class="fas fa-copy"></i> 복사 저장
                        </button>
                        </div>
                        </div>
                </div>

            <div id="plan-table-container-copy" class="panel thick-border">
                <div class="table-container">
                    <table class="list-table" id="daily-plan-table-copy">
                        <thead>
                            <tr id="plan-table-header-copy">
                                <th>날짜</th>
                                <th>시작시간</th>
                                <th>종료시간</th>
                                <th>직원번호</th>
                                <th>직원명</th>
                                <th>활동명</th>
                                <th>코드</th>
                                <th>활동장소</th>
                                <th>준비물품</th>
                                <th>내용및특이사항</th>
                            </tr>
                        </thead>
                        <tbody id="table-body-copy">
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <div id="customConfirm" class="custom-alert">
            <div id="confirm-content" class="custom-alert-content">
                <div id="confirm-header" class="custom-alert-header confirm-header">
                    <i id="confirm-icon" class="fas fa-exclamation-triangle"></i>
                    <span id="confirm-title">확인</span>
                    <button id="close-confirm-x" onclick="closeCustomConfirm(false)" class="close-alert">
                        &times;
                    </button>
                </div>
                <div id="confirm-body" class="custom-alert-body">
                    <p id="customConfirmMessage"></p>
                </div>
                <div id="confirm-footer" class="custom-alert-footer">
                    <button id="confirm-cancel-btn" onclick="closeCustomConfirm(false)" class="alert-cancel-btn">
                        취소
                    </button>
                    <button id="confirm-ok-btn" onclick="closeCustomConfirm(true)"
                        class="alert-confirm-btn confirm-btn">
                        확인
                    </button>
                </div>
            </div>
        </div>
        <div id="customAlert" class="custom-alert">
            <div id="alert-content" class="custom-alert-content">
                <div id="alert-header" class="custom-alert-header">
                    <i id="alert-icon" class="fas fa-info-circle"></i>
                    <span id="alert-title">알림</span>
                    <button id="close-alert-x" onclick="closeCustomAlert()" class="close-alert">
                        &times;
                    </button>
                </div>
                <div id="alert-body" class="custom-alert-body">
                    <p id="customAlertMessage"></p>
                </div>
                <div id="alert-footer" class="custom-alert-footer">
                    <button id="alert-ok-btn" onclick="closeCustomAlert()" class="alert-confirm-btn">
                        확인
                    </button>
                </div>
            </div>
        </div>

    </main>

    <script>
        function showLoading() {
            document.getElementById("loadingOverlay").style.display = "flex";
        }

        function hideLoading() {
            document.getElementById("loadingOverlay").style.display = "none";
        }

        let dailyPlanAll = [];
        let employeeall = [];
        let employeeall_copy = [];
        let copiedPlans = [];

        async function getPlanAllPromise() {
            return await getPlanAll();
        }

        async function getEmployeesPromise() {
            return await getAllEmployees();
        }

        async function appendPlanPromise(planData) {
            return await appendPlan(planData);
        }

        async function updatePlanPromise(planId, planData) {
            return await updatePlan(planId, planData);
        }

        async function deletePlanPromise(planId) {
            return await deletePlanrow(planId);
        }

        async function initialize() {
            showLoading();

            try {
                const results = await Promise.all([
                    getPlanAllPromise(),
                    getEmployeesPromise()
                ]);

                dailyPlanAll = results[0];
                employeeall = results[1];

                makeTable_plan();
            } catch (error) {
                showCustomAlert("데이터를 불러오는데 실패했습니다: " + error.message);
            } finally {
                hideLoading();
            }
        }

        async function getPlanAll_id() {
            showLoading();
            try {
                dailyPlanAll = await getPlanAllPromise();
                makeTable_plan();
            } catch (error) {
                showCustomAlert("데이터를 불러오는데 실패했습니다: " + error);
            } finally {
                hideLoading();
            }
        }

        async function loadStaffList() {
            showLoading();
            try {
                employeeall = await getEmployeesPromise();
            } catch (error) {
                showCustomAlert("직원 데이터를 불러오는데 실패했습니다: " + error);
            } finally {
                hideLoading();
            }
        }

        function changeDate(dateStr) {
            if (!dateStr) return '';

            if (typeof dateStr !== 'string') {
                dateStr = String(dateStr);
            }

            return dateStr.replace(/-/g, "");
        }

        function makeTable_plan() {
            const selectedDate = changeDate(
                document.getElementById("datePicker").value
            );

            if (!selectedDate) {
                return;
            }

            const filteredPlans = dailyPlanAll.filter((plan) => {
                return plan[1] == selectedDate;
            });

            filteredPlans.sort((a, b) => {
                const timeA = a[2].replace(/'/g, "");
                const timeB = b[2].replace(/'/g, "");
                if (timeA !== timeB) {
                    return timeA.localeCompare(timeB);
                }
                return a[5].localeCompare(b[5]);
            });

            const tableBody = document.getElementById("table-body");
            tableBody.innerHTML = "";

            if (filteredPlans.length === 0) {
                const emptyRow = document.createElement("tr");
                const emptyCell = document.createElement("td");
                emptyCell.colSpan = 10;
                emptyCell.textContent = "해당 날짜의 계획 데이터가 없습니다.";
                emptyCell.style.textAlign = "center";
                emptyCell.style.padding = "20px";
                emptyRow.appendChild(emptyCell);
                tableBody.appendChild(emptyRow);
                return;
            }

            displaySortedData(filteredPlans);
        }

        let currentSortColumn = 1;
        let isAscending = true;
        
        let currentSortColumnCopy = 1;
        let isAscendingCopy = true;

        function displaySortedData(data) {
            const tableBody = document.getElementById("table-body");
            tableBody.innerHTML = "";

            data.forEach((plan) => {
                const row = document.createElement("tr");

                const columns = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];

                columns.forEach((index) => {
                    const cell = document.createElement("td");
                    cell.textContent = plan[index] || "";
                    row.appendChild(cell);
                });

                row.addEventListener("dblclick", function () {
                    copyPlanToTarget(plan);
                });

                tableBody.appendChild(row);
            });
        }

        document.addEventListener("DOMContentLoaded", function () {

            const headers = document.querySelectorAll("#plan-table-header th");
            headers.forEach((header, index) => {
                header.style.cursor = "pointer";
                header.addEventListener("click", () => sortTable(index));
            });
            
            const headersCopy = document.querySelectorAll("#plan-table-header-copy th");
            headersCopy.forEach((header, index) => {
                header.style.cursor = "pointer";
                header.addEventListener("click", () => sortTableCopy(index));
            });
        });

        function sortTable(columnIndex) {
            const selectedDate = changeDate(document.getElementById("datePicker").value);
            let filteredPlans = dailyPlanAll.filter((plan) => {
                return plan[1] == selectedDate;
            });

            if (columnIndex === currentSortColumn) {
                isAscending = !isAscending;
            } else {
                currentSortColumn = columnIndex;
                isAscending = true;
            }

            const dataIndexMap = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
            const dataIndex = dataIndexMap[columnIndex];

            filteredPlans.sort((a, b) => {
                let valueA = (a[dataIndex] || "").toString().replace(/'/g, "");
                let valueB = (b[dataIndex] || "").toString().replace(/'/g, "");

                if (dataIndex === 2 || dataIndex === 3) {
                    valueA = valueA.padStart(4, '0');
                    valueB = valueB.padStart(4, '0');
                }

                if (isAscending) {
                    return valueA.localeCompare(valueB);
                } else {
                    return valueB.localeCompare(valueA);
                }
            });

            displaySortedData(filteredPlans);
        }

        function sortTableCopy(columnIndex) {
            if (copiedPlans.length === 0) {
                return;
            }

            if (columnIndex === currentSortColumnCopy) {
                isAscendingCopy = !isAscendingCopy;
            } else {
                currentSortColumnCopy = columnIndex;
                isAscendingCopy = true;
            }

            const dataIndexMap = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
            const dataIndex = dataIndexMap[columnIndex];

            copiedPlans.sort((a, b) => {
                let valueA = (a[dataIndex] || "").toString().replace(/'/g, "");
                let valueB = (b[dataIndex] || "").toString().replace(/'/g, "");

                if (dataIndex === 2 || dataIndex === 3) {
                    valueA = valueA.padStart(4, '0');
                    valueB = valueB.padStart(4, '0');
                }

                if (isAscendingCopy) {
                    return valueA.localeCompare(valueB);
                } else {
                    return valueB.localeCompare(valueA);
                }
            });

            displayCopiedData(copiedPlans);
        }

        function filterCodes(searchTerm) {
            searchTerm = searchTerm.toLowerCase();
            const codeListItems = document.querySelectorAll(".code-list li");

            if (searchTerm === "") {
                document
                    .querySelectorAll(".code-group")
                    .forEach((group) => (group.style.display = ""));
                codeListItems.forEach((item) => (item.style.display = ""));
            } else {
                document.querySelectorAll(".code-group").forEach((group) => {
                    group.style.display = "";
                    const items = group.querySelectorAll(".code-list li");
                    let hasVisibleItems = false;
                    items.forEach((item) => {
                        const text = item.textContent.toLowerCase();
                        if (text.includes(searchTerm)) {
                            item.style.display = "";
                            hasVisibleItems = true;
                        } else {
                            item.style.display = "none";
                        }
                    });
                    if (!hasVisibleItems) group.style.display = "none";
                });
            }
        }

        function showCustomAlert(message) {
            document.getElementById("customAlertMessage").textContent = message;
            document.getElementById("customAlert").style.display = "flex";
        }

        function closeCustomAlert() {
            document.getElementById("customAlert").style.display = "none";
        }

        function showCustomConfirm(message, onConfirm, onCancel) {
            document.getElementById("customConfirmMessage").textContent = message;
            document.getElementById("customConfirm").style.display = "flex";

            document.getElementById("confirm-ok-btn").onclick = function () {
                closeCustomConfirm(true);
                if (typeof onConfirm === 'function') {
                    onConfirm();
                }
            };

            document.getElementById("confirm-cancel-btn").onclick = function () {
                closeCustomConfirm(false);
                if (typeof onCancel === 'function') {
                    onCancel();
                }
            };
        }

        function closeCustomConfirm(confirmed) {
            document.getElementById("customConfirm").style.display = "none";
            return confirmed;
        }

        async function saveCopiedPlans() {
            showLoading();
            try {
                const targetDate = changeDate(document.getElementById("datePickerCopy").value);
                
                if (!targetDate) {
                    showCustomAlert("복사할 날짜를 선택해주세요.");
                    return;
                }

                if (copiedPlans.length === 0) {
                    showCustomAlert("복사할 계획이 없습니다.");
                    return;
                }

                const existingPlans = dailyPlanAll.filter(plan => {
                    return plan[1] == targetDate;
                });
                
                if (existingPlans.length > 0) {
                    for (const existingPlan of existingPlans) {
                        await deletePlanPromise(existingPlan[0]);
                    }
                }

                for (const plan of copiedPlans) {
                    const planData = [
                        "",
                        targetDate,
                        plan[2],
                        plan[3],
                        plan[4],
                        plan[5],
                        plan[6],
                        plan[7],
                        plan[8],
                        plan[9],
                        plan[10],
                        plan[11],
                        plan[12]
                    ];

                    await appendPlanPromise(planData);
                }

                showCustomAlert(`${copiedPlans.length}개의 계획이 성공적으로 복사 저장되었습니다.`);
                
                copiedPlans = [];
                makeTable_plan_copy();
                
                await getPlanAll_id();
                
            } catch (error) {
                showCustomAlert("복사 저장 중 오류가 발생했습니다: " + error);
            } finally {
                hideLoading();
            }
        }

        function makeTable_plan_copy() {
            const tableBody = document.getElementById("table-body-copy");
            tableBody.innerHTML = "";

            if (copiedPlans.length === 0) {
                const emptyRow = document.createElement("tr");
                const emptyCell = document.createElement("td");
                emptyCell.colSpan = 10;
                emptyCell.textContent = "복사된 계획이 없습니다. 원본 테이블의 행을 더블클릭하여 복사하세요.";
                emptyCell.style.textAlign = "center";
                emptyCell.style.padding = "20px";
                emptyRow.appendChild(emptyCell);
                tableBody.appendChild(emptyRow);
                return;
            }

            displayCopiedData(copiedPlans);
        }

        function displayCopiedData(data) {
            const tableBody = document.getElementById("table-body-copy");
            tableBody.innerHTML = "";

            data.forEach((plan, index) => {
                const row = document.createElement("tr");

                const columns = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];

                columns.forEach((colIndex) => {
                    const cell = document.createElement("td");
                    cell.textContent = plan[colIndex] || "";
                    row.appendChild(cell);
                });

                row.addEventListener("dblclick", function () {
                    removeCopiedPlan(index);
                });

                tableBody.appendChild(row);
            });
        }

        function copyPlanToTarget(plan) {
            const sourceDatePicker = document.getElementById("datePicker").value;
            const targetDatePicker = document.getElementById("datePickerCopy").value;
            
            if (!targetDatePicker) {
                showCustomAlert("복사할 날짜를 먼저 선택해주세요.");
                return;
            }
            
            if (sourceDatePicker === targetDatePicker) {
                showCustomAlert("같은 날짜로는 복사할 수 없습니다. 다른 날짜를 선택해주세요.");
                return;
            }

            const employeeId = plan[4];
            const employeeName = plan[5];
            
            const employeeIds = employeeId.split(',').map(id => id.trim());
            const employeeNames = employeeName.split(',').map(name => name.trim());
            
            const allValidEmployees = employeeIds.every(id => 
                employeeall_copy.some(emp => emp[0] === id)
            );
            
            if (!allValidEmployees) {
                showEmployeeSelectionModal(plan, employeeIds, employeeNames);
                return;
            }

            const isAlreadyCopied = copiedPlans.some(copiedPlan => 
                copiedPlan[0] === plan[0] &&
                copiedPlan[2] === plan[2] &&
                copiedPlan[3] === plan[3] &&
                copiedPlan[5] === plan[5]
            );

            if (isAlreadyCopied) {
                showCustomAlert("이미 복사된 계획입니다.");
                return;
            }

            const targetDateFormatted = changeDate(targetDatePicker);
            const copiedPlan = [...plan];
            copiedPlan[1] = targetDateFormatted;

            copiedPlans.push(copiedPlan);
            
            makeTable_plan_copy();
            
        }

        function removeCopiedPlan(index) {
            copiedPlans.splice(index, 1);
            makeTable_plan_copy();
            showCustomAlert("복사된 계획이 제거되었습니다.");
        }

        function showEmployeeSelectionModal(originalPlan, invalidEmployeeIds, invalidEmployeeNames) {
            document.getElementById("staff-modal-title").textContent = "기존 계획 관련 재직 직원 재선택";
            
            document.getElementById("staffSelectModal").style.display = "block";
            
            populateValidStaffTableForSelection();
            
            const selectCompleteBtn = document.getElementById("selectStaffCompleteBtn");
            
            const newSelectCompleteBtn = selectCompleteBtn.cloneNode(true);
            selectCompleteBtn.parentNode.replaceChild(newSelectCompleteBtn, selectCompleteBtn);
            
            newSelectCompleteBtn.addEventListener("click", function() {
                const checkboxes = document.querySelectorAll("#staff-list-body input[type='checkbox']:checked");
                
                if (checkboxes.length === 0) {
                    showCustomAlert("선택된 직원이 없습니다. 직원을 선택해주세요.");
                    return;
                }
                
                const selectedIds = [];
                const selectedNames = [];
                
                checkboxes.forEach(checkbox => {
                    selectedIds.push(checkbox.dataset.employeeId);
                    selectedNames.push(checkbox.dataset.employeeName);
                });
                
                const updatedPlan = [...originalPlan];
                updatedPlan[4] = selectedIds.join(', ');
                updatedPlan[5] = selectedNames.join(', ');
                
                copyPlanWithValidEmployee(updatedPlan);
                
                document.getElementById("staffSelectModal").style.display = "none";
            });
        }

        function copyPlanWithValidEmployee(plan) {
            const targetDatePicker = document.getElementById("datePickerCopy").value;
            
            const isAlreadyCopied = copiedPlans.some(copiedPlan => 
                copiedPlan[0] === plan[0] &&
                copiedPlan[2] === plan[2] &&
                copiedPlan[3] === plan[3] &&
                copiedPlan[5] === plan[5]
            );

            if (isAlreadyCopied) {
                showCustomAlert("이미 복사된 계획입니다.");
                return;
            }

            const targetDateFormatted = changeDate(targetDatePicker);
            const copiedPlan = [...plan];
            copiedPlan[1] = targetDateFormatted;

            copiedPlans.push(copiedPlan);
            
            makeTable_plan_copy();
            
        }

        function updateSelectedEmployeeCount(count) {
        }

        function populateValidStaffTableForSelection() {
            const tableBody = document.getElementById("staff-list-body");
            tableBody.innerHTML = "";

            if (employeeall_copy.length === 0) {
                const row = document.createElement("tr");
                const cell = document.createElement("td");
                cell.colSpan = 3;
                cell.textContent = "복사할 날짜에 계약기간이 유효한 직원이 없습니다.";
                cell.style.textAlign = "center";
                cell.style.padding = "20px";
                row.appendChild(cell);
                tableBody.appendChild(row);
                return;
            }

            const sortedEmployees = [...employeeall_copy].sort((a, b) => {
                const idA = a[0] || "";
                const idB = b[0] || "";
                return idA.localeCompare(idB);
            });

            sortedEmployees.forEach(employee => {
                const row = document.createElement("tr");
                row.style.cursor = "pointer";

                const checkboxCell = document.createElement("td");
                const checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.style.cursor = "pointer";
                checkbox.dataset.employeeId = employee[0] || "";
                checkbox.dataset.employeeName = employee[1] || "";
                checkboxCell.appendChild(checkbox);

                const idCell = document.createElement("td");
                idCell.textContent = employee[0] || "";

                const nameCell = document.createElement("td");
                nameCell.textContent = employee[1] || "";

                row.appendChild(checkboxCell);
                row.appendChild(idCell);
                row.appendChild(nameCell);
                tableBody.appendChild(row);

                row.addEventListener("click", function(e) {
                    if (e.target.type !== "checkbox") {
                        checkbox.checked = !checkbox.checked;
                    }
                });
            });

            const infoRow = document.createElement("tr");
            const infoCell = document.createElement("td");
            infoCell.colSpan = 3;
            infoCell.innerHTML = "<small style='color: #666;'>• 체크박스 또는 행 클릭으로 직원 선택/해제<br>• 선택완료 버튼을 클릭하여 완료</small>";
            infoCell.style.textAlign = "center";
            infoCell.style.padding = "10px";
            infoCell.style.backgroundColor = "#f8f9fa";
            infoRow.appendChild(infoCell);
            tableBody.appendChild(infoRow);
        }

        function populateValidStaffTable() {
            const tableBody = document.getElementById("staff-list-body");
            tableBody.innerHTML = "";

            if (employeeall_copy.length === 0) {
                const row = document.createElement("tr");
                const cell = document.createElement("td");
                cell.colSpan = 2;
                cell.textContent = "복사할 날짜에 계약기간이 유효한 직원이 없습니다.";
                cell.style.textAlign = "center";
                cell.style.padding = "20px";
                row.appendChild(cell);
                tableBody.appendChild(row);
                return;
            }

            const sortedEmployees = [...employeeall_copy].sort((a, b) => {
                const nameA = a[1] || "";
                const nameB = b[1] || "";
                return nameA.localeCompare(nameB);
            });

            sortedEmployees.forEach(employee => {
                const row = document.createElement("tr");

                const idCell = document.createElement("td");
                idCell.textContent = employee[0] || "";

                const nameCell = document.createElement("td");
                nameCell.textContent = employee[1] || "";

                row.appendChild(idCell);
                row.appendChild(nameCell);
                tableBody.appendChild(row);
            });
        }

        function updateEmployeeCopyList(targetDateFormatted) {
            employeeall_copy = [];
            
            if (!employeeall || employeeall.length <= 1) {
                return;
            }
            
            for (let i = 1; i < employeeall.length; i++) {
                const employee = employeeall[i];
                const startDate = employee[2] || "";
                const endDate = employee[3] || "";
                
                if (startDate && targetDateFormatted >= startDate &&
                    (!endDate || targetDateFormatted <= endDate)) {
                    employeeall_copy.push(employee);
                }
            }
        }

        function checkExistingPlansForCopyDate() {
            const targetDatePicker = document.getElementById("datePickerCopy").value;
            const sourceDatePicker = document.getElementById("datePicker").value;
            
            if (!targetDatePicker) {
                employeeall_copy = [];
                return;
            }
            
            if (sourceDatePicker === targetDatePicker) {
                showCustomAlert("같은 날짜로는 복사할 수 없습니다. 다른 날짜를 선택해주세요.");
                document.getElementById("datePickerCopy").value = "";
                employeeall_copy = [];
                return;
            }
            
            const targetDateFormatted = changeDate(targetDatePicker);
            
            updateEmployeeCopyList(targetDateFormatted);
            
            const existingPlans = dailyPlanAll.filter(plan => {
                return plan[1] == targetDateFormatted;
            });
            
            if (existingPlans.length > 0) {
                showCustomConfirm(
                    `선택한 날짜(${targetDatePicker})에 ${existingPlans.length}개의 기존 계획이 있습니다.\n기존 계획을 모두 삭제한 후 복사된 계획으로 대체하시겠습니까?`, 
                    async function () {
                        showLoading();
                        try {
                            for (const existingPlan of existingPlans) {
                                await deletePlanPromise(existingPlan[0]);
                            }
                            
                            await getPlanAll_id();
                            
                            showCustomAlert(`${existingPlans.length}개의 기존 계획이 삭제되었습니다. 이제 복사할 계획을 선택하고 저장해주세요.`);
                        } catch (error) {
                            showCustomAlert("기존 계획 삭제 중 오류가 발생했습니다: " + error);
                        } finally {
                            hideLoading();
                        }
                    },
                    function () {
                        document.getElementById("datePickerCopy").value = "";
                    }
                );
            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            initSupabase();

            const today = new Date().toISOString().split("T")[0];
            document.getElementById("datePicker").value = today;

            initialize();

            makeTable_plan_copy();

            document.getElementById("btn-plan-search").addEventListener("click", function () {
                getPlanAll_id();
            });

            document.getElementById("btn-copy-save").addEventListener("click", function () {
                showCustomConfirm("복사된 계획들을 선택한 날짜로 저장하시겠습니까?", function () {
                    saveCopiedPlans();
                });
            });

            document.getElementById("datePickerCopy").addEventListener("change", function () {
                copiedPlans = [];
                makeTable_plan_copy();
                checkExistingPlansForCopyDate();
            });

            document.getElementById("close-staff-btn").addEventListener("click", function () {
                document.getElementById("staffSelectModal").style.display = "none";
                document.getElementById("staff-modal-title").textContent = "기존 계획 관련 재직 직원 재선택";
            });

            document.getElementById("resetManagerBtn").addEventListener("click", function () {
                document.getElementById("staffSearchBox").value = "";
                populateValidStaffTable();
            });

            document.getElementById("staffSearchBox").addEventListener("input", function () {
                const searchTerm = this.value;
                filterValidStaffList(searchTerm);
            });
        });

        function populateStaffTable(staffData) {
            const tableBody = document.getElementById("staff-list-body");
            tableBody.innerHTML = "";

            const selectedDate = changeDate(document.getElementById("datePicker").value);

            let filteredStaff = [];

            for (let i = 1; i < staffData.length; i++) {
                const startDate = staffData[i][2] || "";
                const endDate = staffData[i][3] || "";

                if (startDate && selectedDate >= startDate &&
                    (!endDate || selectedDate <= endDate)) {
                    filteredStaff.push(staffData[i]);
                }
            }

            filteredStaff.sort((a, b) => {
                const nameA = a[1] || "";
                const nameB = b[1] || "";
                return nameA.localeCompare(nameB);
            });

            for (let i = 0; i < filteredStaff.length; i++) {
                const row = document.createElement("tr");

                const idCell = document.createElement("td");
                idCell.textContent = filteredStaff[i][0] || "";

                const nameCell = document.createElement("td");
                nameCell.textContent = filteredStaff[i][1] || "";

                row.appendChild(idCell);
                row.appendChild(nameCell);

                row.addEventListener("dblclick", function () {
                    showCustomAlert("Plan Entry 영역이 제거되어 직원명 선택 기능이 비활성화되었습니다.");
                });

                tableBody.appendChild(row);
            }

            if (filteredStaff.length === 0) {
                const row = document.createElement("tr");
                const cell = document.createElement("td");
                cell.colSpan = 2;
                cell.textContent = "선택한 날짜에 해당하는 재직 중인 직원이 없습니다.";
                cell.style.textAlign = "center";
                cell.style.padding = "20px";
                row.appendChild(cell);
                tableBody.appendChild(row);
            }
        }

        function filterStaffList(searchTerm) {
            searchTerm = searchTerm.toLowerCase();
            const rows = document.querySelectorAll("#staff-list-body tr");

            rows.forEach(function (row) {
                const empId = row.children[0].textContent.toLowerCase();
                const empName = row.children[1].textContent.toLowerCase();

                if (empId.includes(searchTerm) || empName.includes(searchTerm)) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            });
        }

        function filterValidStaffList(searchTerm) {
            searchTerm = searchTerm.toLowerCase();
            const rows = document.querySelectorAll("#staff-list-body tr");

            rows.forEach(function (row) {
                if (row.children.length >= 2) {
                    const empId = row.children[0].textContent.toLowerCase();
                    const empName = row.children[1].textContent.toLowerCase();

                    if (empId.includes(searchTerm) || empName.includes(searchTerm)) {
                        row.style.display = "";
                    } else {
                        row.style.display = "none";
                    }
                }
            });
        }

    </script>

</body>

</html>
